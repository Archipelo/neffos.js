"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var WebSocket,isBrowser="undefined"!=typeof window;WebSocket=isBrowser?window.WebSocket:require("ws");var OnNamespaceConnect="_OnNamespaceConnect",OnNamespaceConnected="_OnNamespaceConnected",OnNamespaceDisconnect="_OnNamespaceDisconnect",OnRoomJoin="_OnRoomJoin",OnRoomJoined="_OnRoomJoined",OnRoomLeave="_OnRoomLeave", OnRoomLeft="_OnRoomLeft",OnAnyEvent="_OnAnyEvent",OnNativeMessage="_OnNativeMessage";var ackBinary="M",ackIDBinary="A",ackNotOKBinary="H",waitIsConfirmationPrefix="#",waitComesFromClientPrefix="$";function IsSystemEvent(event){switch(event){case OnNamespaceConnect:case OnNamespaceConnected:case OnNamespaceDisconnect:case OnRoomJoin:case OnRoomJoined:case OnRoomLeave:case OnRoomLeft:return!0;default:return!1}}function isEmpty(s){return void 0===s||(null===s||("string"==typeof s||s instanceof String?0===s.length||""===s:s instanceof Error&&isEmpty(s.message)))}var Message=function(){function Message(){_classCallCheck(this,Message)}return _createClass(Message,[{key:"isConnect",value:function(){return this.Event==OnNamespaceConnect||!1}},{key:"isDisconnect",value:function(){return this.Event==OnNamespaceDisconnect||!1}},{key:"isRoomJoin",value:function(){return this.Event==OnRoomJoin||!1}},{key:"isRoomLeft",value:function(){return this.Event==OnRoomLeft||!1}},{key:"isWait",value:function(){return!isEmpty(this.wait)&&(this.wait[0]==waitIsConfirmationPrefix||(this.wait[0]==waitComesFromClientPrefix||!1))}}]),Message}();var messageSeparator=";",validMessageSepCount=7,trueString="1",falseString="0";function serializeMessage(msg){if(msg.IsNative&&isEmpty(msg.wait))return msg.Body;var isErrorString=falseString,isNoOpString=falseString,body=msg.Body||"";return msg.isError&&(body=msg.Err,isErrorString=trueString),msg.isNoOp&&(isNoOpString=trueString),[msg.wait||"",msg.Namespace,msg.Room||"",msg.Event||"",isErrorString,isNoOpString,body].join(messageSeparator)}function deserializeMessage(data,allowNativeMessages){var msg=new Message;if(0==data.length)return msg.isInvalid=!0,msg;var dts=data.split(messageSeparator,validMessageSepCount);if(dts.length!=validMessageSepCount)return allowNativeMessages?(msg.Event=OnNativeMessage,msg.Body=data):msg.isInvalid=!0,msg;msg.wait=dts[0],msg.Namespace=dts[1],msg.Room=dts[2],msg.Event=dts[3],msg.isError=dts[4]==trueString||!1,msg.isNoOp=dts[5]==trueString||!1;var body=dts[6];return isEmpty(body)?msg.Body="":msg.isError?msg.Err=body:msg.Body=body,msg.isInvalid=!1,msg.IsForced=!1,msg.IsLocal=!1,msg.IsNative=allowNativeMessages&&msg.Event==OnNativeMessage||!1,msg}function genWait(){if(isBrowser){var now=window.performance.now();return waitComesFromClientPrefix+now.toString()}var hrTime=process.hrtime();return waitComesFromClientPrefix+1e9*hrTime[0]+hrTime[1]}function genWaitConfirmation(wait){return waitIsConfirmationPrefix+wait}function genEmptyReplyToWait(wait){return wait+messageSeparator.repeat(validMessageSepCount-1)}var Room=function(){function Room(ns,roomName){_classCallCheck(this,Room),this.nsConn=ns,this.name=roomName}return _createClass(Room,[{key:"Emit",value:function(event,body){var msg=new Message;return msg.Namespace=this.nsConn.namespace,msg.Room=this.name,msg.Event=event,msg.Body=body,this.nsConn.conn.Write(msg)}},{key:"Leave",value:function(){var msg=new Message;return msg.Namespace=this.nsConn.namespace,msg.Room=this.name,msg.Event=OnRoomLeave,this.nsConn.askRoomLeave(msg)}}]),Room}();var NSConn=function(){function NSConn(conn,namespace,events){_classCallCheck(this,NSConn),this.conn=conn,this.namespace=namespace,this.events=events,this.rooms=new Map}return _createClass(NSConn,[{key:"Emit",value:function(event,body){var msg=new Message;return msg.Namespace=this.namespace,msg.Event=event,msg.Body=body,this.conn.Write(msg)}},{key:"Ask",value:function(event,body){var msg=new Message;return msg.Namespace=this.namespace,msg.Event=event,msg.Body=body,this.conn.Ask(msg)}},{key:"JoinRoom",value:function(roomName){return this.askRoomJoin(roomName)}},{key:"Room",value:function(roomName){return this.rooms.get(roomName)}},{key:"Rooms",value:function(){var rooms=new Array(this.rooms.size);return this.rooms.forEach(function(room){rooms.push(room)}),rooms}},{key:"LeaveAll",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee2(){var leaveMsg,_this=this;return regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return(leaveMsg=new Message).Namespace=this.namespace,leaveMsg.Event=OnRoomLeft,leaveMsg.IsLocal=!0,this.rooms.forEach(function(value,roomName){return __awaiter(_this,void 0,void 0,regeneratorRuntime.mark(function _callee(){return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return leaveMsg.Room=roomName,_context.prev=1,_context.next=4,this.askRoomLeave(leaveMsg);case 4:_context.next=9;break;case 6:return _context.prev=6,_context.t0=_context.catch(1),_context.abrupt("return",_context.t0);case 9:case"end":return _context.stop()}},_callee,this,[[1,6]])}))}),_context2.abrupt("return",null);case 6:case"end":return _context2.stop()}},_callee2,this)}))}},{key:"forceLeaveAll",value:function(isLocal){var _this2=this,leaveMsg=new Message;leaveMsg.Namespace=this.namespace,leaveMsg.Event=OnRoomLeave,leaveMsg.IsForced=!0,leaveMsg.IsLocal=isLocal,this.rooms.forEach(function(value,roomName){leaveMsg.Room=roomName,fireEvent(_this2,leaveMsg),_this2.rooms.delete(roomName),leaveMsg.Event=OnRoomLeft,fireEvent(_this2,leaveMsg),leaveMsg.Event=OnRoomLeave})}},{key:"Disconnect",value:function(){var disconnectMsg=new Message;return disconnectMsg.Namespace=this.namespace,disconnectMsg.Event=OnNamespaceDisconnect,this.conn.askDisconnect(disconnectMsg)}},{key:"askRoomJoin",value:function(roomName){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee3(){var room,joinMsg,err;return regeneratorRuntime.wrap(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:if(void 0!==(room=this.rooms.get(roomName)))return _context3.abrupt("return",room);_context3.next=3;break;case 3:return(joinMsg=new Message).Namespace=this.namespace,joinMsg.Room=roomName,joinMsg.Event=OnRoomJoin,joinMsg.IsLocal=!0,_context3.prev=8,_context3.next=11,this.conn.Ask(joinMsg);case 11:_context3.next=16;break;case 13:return _context3.prev=13,_context3.t0=_context3.catch(8),_context3.abrupt("return",_context3.t0);case 16:if(isEmpty(err=fireEvent(this,joinMsg))){_context3.next=19;break}return _context3.abrupt("return",err);case 19:return room=new Room(this,roomName),this.rooms.set(roomName,room),joinMsg.Event=OnRoomJoined,fireEvent(this,joinMsg),_context3.abrupt("return",room);case 24:case"end":return _context3.stop()}},_callee3,this,[[8,13]])}))}},{key:"askRoomLeave",value:function(msg){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee4(){var err;return regeneratorRuntime.wrap(function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:if(this.rooms.has(msg.Room)){_context4.next=2;break}return _context4.abrupt("return",ErrBadRoom);case 2:return _context4.prev=2,_context4.next=5,this.conn.Ask(msg);case 5:_context4.next=10;break;case 7:return _context4.prev=7,_context4.t0=_context4.catch(2),_context4.abrupt("return",_context4.t0);case 10:if(isEmpty(err=fireEvent(this,msg))){_context4.next=13;break}return _context4.abrupt("return",err);case 13:return this.rooms.delete(msg.Room),msg.Event=OnRoomLeft,fireEvent(this,msg),_context4.abrupt("return",null);case 17:case"end":return _context4.stop()}},_callee4,this,[[2,7]])}))}},{key:"replyRoomJoin",value:function(msg){if(!isEmpty(msg.wait)&&!msg.isNoOp){if(!this.rooms.has(msg.Room)){var err=fireEvent(this,msg);if(!isEmpty(err))return msg.Err=err.message,void this.conn.Write(msg);this.rooms.set(msg.Room,new Room(this,msg.Room)),msg.Event=OnRoomJoined,fireEvent(this,msg)}this.conn.writeEmptyReply(msg.wait)}}},{key:"replyRoomLeave",value:function(msg){isEmpty(msg.wait)||msg.isNoOp||(this.rooms.has(msg.Room)?(fireEvent(this,msg),this.rooms.delete(msg.Room),this.conn.writeEmptyReply(msg.wait),msg.Event=OnRoomLeft,fireEvent(this,msg)):this.conn.writeEmptyReply(msg.wait))}}]),NSConn}();function fireEvent(ns,msg){return ns.events.hasOwnProperty(msg.Event)?ns.events[msg.Event](ns,msg):ns.events.hasOwnProperty(OnAnyEvent)?ns.events[OnAnyEvent](ns,msg):null}function getEvents(namespaces,namespace){return namespaces.hasOwnProperty(namespace)?namespaces[namespace]:null}function Dial(endpoint,connHandler,protocols){return-1==endpoint.indexOf("ws")&&(endpoint="ws://"+endpoint),new Promise(function(resolve,reject){WebSocket||reject("WebSocket is not accessible through this browser."),void 0===connHandler&&reject("connHandler is empty.");var ws=new WebSocket(endpoint,protocols),conn=new Conn(ws,connHandler,protocols);ws.binaryType="arraybuffer",ws.onmessage=function(evt){var err=conn.handle(evt);isEmpty(err)?conn.IsAcknowledged()&&resolve(conn):reject(err)},ws.onopen=function(evt){ws.send(ackBinary)},ws.onerror=function(err){conn.Close(),reject(err)}})}const ErrInvalidPayload=new Error("invalid payload"), ErrBadNamespace=new Error("bad namespace"), ErrBadRoom=new Error("bad room"),ErrClosed=new Error("use of closed connection"), ErrWrite=new Error("write closed");var Conn=function(){function Conn(conn,connHandler,protocols){var _this3=this;_classCallCheck(this,Conn),this.conn=conn,this.isAcknowledged=!1;var hasEmptyNS=connHandler.hasOwnProperty("");this.allowNativeMessages=hasEmptyNS&&connHandler[""].hasOwnProperty(OnNativeMessage),this.queue=new Array,this.waitingMessages=new Map,this.namespaces=connHandler,this.connectedNamespaces=new Map,this.closed=!1,this.conn.onclose=function(evt){return _this3.Close(),null}}return _createClass(Conn,[{key:"IsAcknowledged",value:function(){return this.isAcknowledged}},{key:"handle",value:function(evt){if(this.isAcknowledged)return this.handleMessage(evt.data);var err=this.handleAck(evt.data);return null==err?(this.isAcknowledged=!0,this.handleQueue()):this.conn.close(),err}},{key:"handleAck",value:function(data){switch(data[0]){case ackIDBinary:var id=data.slice(1);this.ID=id;break;case ackNotOKBinary:var errorText=data.slice(1);return new Error(errorText);default:return this.queue.push(data),null}}},{key:"handleQueue",value:function(){var _this4=this;null!=this.queue&&0!=this.queue.length&&this.queue.forEach(function(item,index){_this4.queue.splice(index,1),_this4.handleMessage(item)})}},{key:"handleMessage",value:function(data){var msg=deserializeMessage(data,this.allowNativeMessages);if(msg.isInvalid)return ErrInvalidPayload;if(msg.IsNative&&this.allowNativeMessages)return fireEvent(this.Namespace(""),msg);if(msg.isWait()){var cb=this.waitingMessages.get(msg.wait);if(null!=cb)return void cb(msg)}var ns=this.Namespace(msg.Namespace);switch(msg.Event){case OnNamespaceConnect:this.replyConnect(msg);break;case OnNamespaceDisconnect:this.replyDisconnect(msg);break;case OnRoomJoin:if(void 0!==ns){ns.replyRoomJoin(msg);break}case OnRoomLeave:if(void 0!==ns){ns.replyRoomLeave(msg);break}default:if(void 0===ns)return ErrBadNamespace;msg.IsLocal=!1;var err=fireEvent(ns,msg);if(!isEmpty(err))return msg.Err=err.message,this.Write(msg),err}return null}},{key:"Connect",value:function(namespace){return this.askConnect(namespace)}},{key:"Namespace",value:function(namespace){return this.connectedNamespaces.get(namespace)}},{key:"replyConnect",value:function(msg){if(!isEmpty(msg.wait)&&!msg.isNoOp){var ns=this.Namespace(msg.Namespace);if(void 0===ns){var events=getEvents(this.namespaces,msg.Namespace);if(void 0===events)return msg.Err=ErrBadNamespace.message,void this.Write(msg);ns=new NSConn(this,msg.Namespace,events),this.connectedNamespaces.set(msg.Namespace,ns),this.writeEmptyReply(msg.wait),msg.Event=OnNamespaceConnected,fireEvent(ns,msg)}else this.writeEmptyReply(msg.wait)}}},{key:"replyDisconnect",value:function(msg){if(!isEmpty(msg.wait)&&!msg.isNoOp){var ns=this.Namespace(msg.Namespace);void 0!==ns?(ns.forceLeaveAll(!0),this.connectedNamespaces.delete(msg.Namespace),this.writeEmptyReply(msg.wait),fireEvent(ns,msg)):this.writeEmptyReply(msg.wait)}}},{key:"Ask",value:function(msg){var _this5=this;return new Promise(function(resolve,reject){_this5.IsClosed()?reject(ErrClosed):(msg.wait=genWait(),_this5.waitingMessages.set(msg.wait,function(receive){receive.isError?reject(new Error(receive.Err)):resolve(receive)}),_this5.Write(msg)||reject(ErrWrite))})}},{key:"askConnect",value:function(namespace){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee5(){var ns,events,connectMessage,err;return regeneratorRuntime.wrap(function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:if(void 0!==(ns=this.Namespace(namespace)))return _context5.abrupt("return",ns);_context5.next=3;break;case 3:if(void 0===(events=getEvents(this.namespaces,namespace)))return _context5.abrupt("return",ErrBadNamespace);_context5.next=6;break;case 6:if((connectMessage=new Message).Namespace=namespace,connectMessage.Event=OnNamespaceConnect,connectMessage.IsLocal=!0,ns=new NSConn(this,namespace,events),isEmpty(err=fireEvent(ns,connectMessage))){_context5.next=14;break}return _context5.abrupt("return",err);case 14:return _context5.prev=14,_context5.next=17,this.Ask(connectMessage);case 17:_context5.next=22;break;case 19:return _context5.prev=19,_context5.t0=_context5.catch(14),_context5.abrupt("return",_context5.t0);case 22:return this.connectedNamespaces.set(namespace,ns),connectMessage.Event=OnNamespaceConnected,fireEvent(ns,connectMessage),_context5.abrupt("return",ns);case 26:case"end":return _context5.stop()}},_callee5,this,[[14,19]])}))}},{key:"askDisconnect",value:function(msg){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee6(){var ns;return regeneratorRuntime.wrap(function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:if(void 0===(ns=this.Namespace(msg.Namespace)))return _context6.abrupt("return",ErrBadNamespace);_context6.next=3;break;case 3:return _context6.prev=3,_context6.next=6,this.Ask(msg);case 6:_context6.next=11;break;case 8:return _context6.prev=8,_context6.t0=_context6.catch(3),_context6.abrupt("return",_context6.t0);case 11:return ns.forceLeaveAll(!0),this.connectedNamespaces.delete(msg.Namespace),msg.IsLocal=!0,_context6.abrupt("return",fireEvent(ns,msg));case 15:case"end":return _context6.stop()}},_callee6,this,[[3,8]])}))}},{key:"IsClosed",value:function(){return this.closed||this.conn.readyState==this.conn.CLOSED||!1}},{key:"Write",value:function(msg){if(this.IsClosed())return!1;if(!msg.isConnect()&&!msg.isDisconnect()){var ns=this.Namespace(msg.Namespace);if(void 0===ns)return!1;if(!(isEmpty(msg.Room)||msg.isRoomJoin()||msg.isRoomLeft()||ns.rooms.has(msg.Room)))return!1}return this.write(serializeMessage(msg)),!0}},{key:"write",value:function(data){this.conn.send(data)}},{key:"writeEmptyReply",value:function(wait){this.write(genEmptyReplyToWait(wait))}},{key:"Close",value:function(){var _this6=this;if(!this.closed){var disconnectMsg=new Message;disconnectMsg.Event=OnNamespaceDisconnect,disconnectMsg.IsForced=!0,disconnectMsg.IsLocal=!0,this.connectedNamespaces.forEach(function(ns){ns.forceLeaveAll(!0),disconnectMsg.Namespace=ns.namespace,fireEvent(ns,disconnectMsg),_this6.connectedNamespaces.delete(ns.namespace)}),this.waitingMessages.clear(),this.conn.readyState===this.conn.OPEN&&this.conn.close(),this.closed=!0}}}]),Conn}();