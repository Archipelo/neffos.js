var neffos,__awaiter=this&&this.__awaiter||function(a,b,c,d){return new(c||(c=Promise))(function(e,f){function g(a){try{i(d.next(a))}catch(a){f(a)}}function h(a){try{i(d["throw"](a))}catch(a){f(a)}}function i(a){a.done?e(a.value):new c(function(b){b(a.value)}).then(g,h)}i((d=d.apply(a,b||[])).next())})};(function(){function a(b){return!(void 0!==b)||!(null!==b)||("string"==typeof b||b instanceof String?0===b.length||""===b:!!(b instanceof Error)&&a(b.message))}function b(b){if(b.IsNative&&a(b.wait))return b.Body;let c=y,d=y,e=b.Body||"";return b.isError&&(e=b.Err,c=x),b.isNoOp&&(d=x),[b.wait||"",b.Namespace,b.Room||"",b.Event||"",c,d,e].join(v)}function c(b,c){var d=new u;if(0==b.length)return d.isInvalid=!0,d;let e=b.split(v,w);if(e.length!=w)return c?(d.Event=r,d.Body=b):d.isInvalid=!0,d;d.wait=e[0],d.Namespace=e[1],d.Room=e[2],d.Event=e[3],d.isError=e[4]==x||!1,d.isNoOp=e[5]==x||!1;let f=e[6];return a(f)?d.Body="":d.isError?d.Err=f:d.Body=f,d.isInvalid=!1,d.IsForced=!1,d.IsLocal=!1,d.IsNative=c&&d.Event==r||!1,d}function d(){if(!h){let a=process.hrtime();return t+1e9*a[0]+a[1]}else{let a=window.performance.now();return t+a.toString()}}function e(a){return a+v.repeat(6)}function f(a,b){return a.events.hasOwnProperty(b.Event)?a.events[b.Event](a,b):a.events.hasOwnProperty(q)?a.events[q](a,b):null}function g(a,b){return a.hasOwnProperty(b)?a[b]:null}const h="undefined"!=typeof window;var i=h?window.WebSocket:require("ws");const j="_OnNamespaceConnect",k="_OnNamespaceConnected",l="_OnNamespaceDisconnect",m="_OnRoomJoin",n="_OnRoomJoined",o="_OnRoomLeave",p="_OnRoomLeft",q="_OnAnyEvent",r="_OnNativeMessage",s="#",t="$";class u{isConnect(){return this.Event==j||!1}isDisconnect(){return this.Event==l||!1}isRoomJoin(){return this.Event==m||!1}isRoomLeft(){return this.Event==p||!1}isWait(){return!a(this.wait)&&(!(this.wait[0]!=s)||this.wait[0]==t||!1)}}const v=";",w=7,x="1",y="0";class z{constructor(a,b){this.nsConn=a,this.name=b}emit(a,b){let c=new u;return c.Namespace=this.nsConn.namespace,c.Room=this.name,c.Event=a,c.Body=b,this.nsConn.conn.write(c)}leave(){let a=new u;return a.Namespace=this.nsConn.namespace,a.Room=this.name,a.Event=o,this.nsConn.askRoomLeave(a)}}class A{constructor(a,b,c){this.conn=a,this.namespace=b,this.events=c,this.rooms=new Map}emit(a,b){let c=new u;return c.Namespace=this.namespace,c.Event=a,c.Body=b,this.conn.write(c)}ask(a,b){let c=new u;return c.Namespace=this.namespace,c.Event=a,c.Body=b,this.conn.ask(c)}joinRoom(a){return this.askRoomJoin(a)}room(a){return this.rooms.get(a)}leaveAll(){return __awaiter(this,void 0,void 0,function*(){let a=new u;return a.Namespace=this.namespace,a.Event=p,a.IsLocal=!0,this.rooms.forEach((b,c)=>__awaiter(this,void 0,void 0,function*(){a.Room=c;try{yield this.askRoomLeave(a)}catch(a){return a}})),null})}forceLeaveAll(a){let b=new u;b.Namespace=this.namespace,b.Event=o,b.IsForced=!0,b.IsLocal=a,this.rooms.forEach((a,c)=>{b.Room=c,f(this,b),this.rooms.delete(c),b.Event=p,f(this,b),b.Event=o})}disconnect(){let a=new u;return a.Namespace=this.namespace,a.Event=l,this.conn.askDisconnect(a)}askRoomJoin(b){return __awaiter(this,void 0,void 0,function*(){let c=this.rooms.get(b);if(void 0!==c)return c;let d=new u;d.Namespace=this.namespace,d.Room=b,d.Event=m,d.IsLocal=!0;try{yield this.conn.ask(d)}catch(a){return a}let e=f(this,d);return a(e)?(c=new z(this,b),this.rooms.set(b,c),d.Event=n,f(this,d),c):e})}askRoomLeave(b){return __awaiter(this,void 0,void 0,function*(){if(!this.rooms.has(b.Room))return D;try{yield this.conn.ask(b)}catch(a){return a}let c=f(this,b);return a(c)?(this.rooms.delete(b.Room),b.Event=p,f(this,b),null):c})}replyRoomJoin(b){if(!(a(b.wait)||b.isNoOp)){if(!this.rooms.has(b.Room)){let c=f(this,b);if(!a(c))return b.Err=c.message,void this.conn.write(b);this.rooms.set(b.Room,new z(this,b.Room)),b.Event=n,f(this,b)}this.conn.writeEmptyReply(b.wait)}}replyRoomLeave(b){return a(b.wait)||b.isNoOp?void 0:this.rooms.has(b.Room)?void(f(this,b),this.rooms.delete(b.Room),this.conn.writeEmptyReply(b.wait),b.Event=p,f(this,b)):void this.conn.writeEmptyReply(b.wait)}}const B=new Error("invalid payload"),C=new Error("bad namespace"),D=new Error("bad room"),E=new Error("use of closed connection"),F=new Error("write closed");class G{constructor(a,b,c){this.conn=a,this._isAcknowledged=!1;let d=b.hasOwnProperty("");this.allowNativeMessages=d&&b[""].hasOwnProperty(r),this.queue=[],this.waitingMessages=new Map,this.namespaces=b,this.connectedNamespaces=new Map,this.closed=!1,this.conn.onclose=()=>(this.close(),null)}isAcknowledged(){return this._isAcknowledged}handle(a){if(!this._isAcknowledged){let b=this.handleAck(a.data);return null==b?(this._isAcknowledged=!0,this.handleQueue()):this.conn.close(),b}return this.handleMessage(a.data)}handleAck(a){let b=a[0];switch(b){case"A":let c=a.slice(1);this.ID=c;break;case"H":let d=a.slice(1);return new Error(d);default:return this.queue.push(a),null;}}handleQueue(){null==this.queue||0==this.queue.length||this.queue.forEach((a,b)=>{this.queue.splice(b,1),this.handleMessage(a)})}handleMessage(b){let d=c(b,this.allowNativeMessages);if(d.isInvalid)return B;if(d.IsNative&&this.allowNativeMessages){let a=this.namespace("");return f(a,d)}if(d.isWait()){let a=this.waitingMessages.get(d.wait);if(null!=a)return void a(d)}const e=this.namespace(d.Namespace);switch(d.Event){case j:this.replyConnect(d);break;case l:this.replyDisconnect(d);break;case m:if(e!==void 0){e.replyRoomJoin(d);break}case o:if(e!==void 0){e.replyRoomLeave(d);break}default:if(e===void 0)return C;d.IsLocal=!1;let b=f(e,d);if(!a(b))return d.Err=b.message,this.write(d),b;}return null}connect(a){return this.askConnect(a)}namespace(a){return this.connectedNamespaces.get(a)}replyConnect(b){if(a(b.wait)||b.isNoOp)return;let c=this.namespace(b.Namespace);if(void 0!==c)return void this.writeEmptyReply(b.wait);let d=g(this.namespaces,b.Namespace);return void 0===d?(b.Err=C.message,void this.write(b)):void(c=new A(this,b.Namespace,d),this.connectedNamespaces.set(b.Namespace,c),this.writeEmptyReply(b.wait),b.Event=k,f(c,b))}replyDisconnect(b){if(!(a(b.wait)||b.isNoOp)){let a=this.namespace(b.Namespace);return void 0===a?void this.writeEmptyReply(b.wait):void(a.forceLeaveAll(!0),this.connectedNamespaces.delete(b.Namespace),this.writeEmptyReply(b.wait),f(a,b))}}ask(a){return new Promise((b,c)=>this.isClosed()?void c(E):(a.wait=d(),this.waitingMessages.set(a.wait,a=>a.isError?void c(new Error(a.Err)):void b(a)),!this.write(a))?void c(F):void 0)}askConnect(b){return __awaiter(this,void 0,void 0,function*(){let c=this.namespace(b);if(void 0!==c)return c;let d=g(this.namespaces,b);if(void 0===d)return C;let e=new u;e.Namespace=b,e.Event=j,e.IsLocal=!0,c=new A(this,b,d);let h=f(c,e);if(!a(h))return h;try{yield this.ask(e)}catch(a){return a}return this.connectedNamespaces.set(b,c),e.Event=k,f(c,e),c})}askDisconnect(a){return __awaiter(this,void 0,void 0,function*(){let b=this.namespace(a.Namespace);if(void 0===b)return C;try{yield this.ask(a)}catch(a){return a}return b.forceLeaveAll(!0),this.connectedNamespaces.delete(a.Namespace),a.IsLocal=!0,f(b,a)})}isClosed(){return this.closed||this.conn.readyState==this.conn.CLOSED||!1}write(c){if(this.isClosed())return!1;if(!c.isConnect()&&!c.isDisconnect()){let b=this.namespace(c.Namespace);if(void 0===b)return!1;if(!a(c.Room)&&!c.isRoomJoin()&&!c.isRoomLeft()&&!b.rooms.has(c.Room))return!1}return this.conn.send(b(c)),!0}writeEmptyReply(a){this.conn.send(e(a))}close(){if(this.closed)return;let a=new u;a.Event=l,a.IsForced=!0,a.IsLocal=!0,this.connectedNamespaces.forEach(b=>{b.forceLeaveAll(!0),a.Namespace=b.namespace,f(b,a),this.connectedNamespaces.delete(b.namespace)}),this.waitingMessages.clear(),this.conn.readyState===this.conn.OPEN&&this.conn.close(),this.closed=!0}}})(neffos||(neffos={}));